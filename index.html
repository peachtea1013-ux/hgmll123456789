<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, viewport-fit=cover">
<title>在庫管理PWA（STEP2 完成）</title>

<style>
/* ===== iOS Safari / PWA ズレ対策 ===== */
html, body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
  background: #f6f7f9;
  height: 100%;
}
button, input, select {
  font-size: 16px;
}
header {
  padding: env(safe-area-inset-top) 12px 12px;
  background: #222;
  color: #fff;
}
main {
  padding: 12px;
}
section {
  background: #fff;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 12px;
}
h2 {
  margin: 0 0 8px 0;
  font-size: 16px;
}
label {
  display: block;
  font-size: 13px;
  margin-top: 6px;
}
input, select {
  width: 100%;
  padding: 6px;
  margin-top: 2px;
}
button {
  margin-top: 10px;
  padding: 8px;
  width: 100%;
  border: none;
  border-radius: 6px;
  background: #007aff;
  color: #fff;
}
button.danger {
  background: #d93025;
}
.list-item {
  border-bottom: 1px solid #ddd;
  padding: 6px 0;
}
.small {
  font-size: 12px;
  color: #666;
}
.flex {
  display: flex;
  gap: 6px;
}
.flex button {
  width: auto;
  flex: 1;
}
</style>
</head>

<body>
<header>
  <strong>在庫管理（STEP2 商品マスター）</strong>
</header>

<main>

<!-- ===== 商品マスター登録 ===== -->
<section>
  <h2>商品マスター 新規登録</h2>

  <label>商品コード（必須・一意）</label>
  <input id="code">

  <label>商品名</label>
  <input id="name">

  <label>カテゴリー</label>
  <input id="category">

  <label>メーカー</label>
  <input id="maker">

  <label>型番</label>
  <input id="model">

  <button onclick="addProduct()">登録</button>
</section>

<!-- ===== 商品マスター一覧 ===== -->
<section>
  <h2>商品マスター一覧</h2>
  <div id="productList"></div>
</section>

<!-- ===== 在庫操作 ===== -->
<section>
  <h2>在庫操作</h2>

  <label>商品選択</label>
  <select id="productSelect"></select>

  <label>数量</label>
  <input id="qty" type="number" value="1">

  <div class="flex">
    <button onclick="stockIn()">入庫</button>
    <button class="danger" onclick="stockOut()">使用</button>
  </div>
</section>

<!-- ===== 履歴 ===== -->
<section>
  <h2>履歴</h2>
  <div id="historyList"></div>
</section>

</main>

<script>
/* =====================
   LocalStorage 構造
   products: [{code,name,category,maker,model,stock}]
   history: [{time,code,type,qty}]
===================== */

const LS_PRODUCTS = "products_v2";
const LS_HISTORY  = "history_v2";

function loadProducts() {
  return JSON.parse(localStorage.getItem(LS_PRODUCTS) || "[]");
}
function saveProducts(data) {
  localStorage.setItem(LS_PRODUCTS, JSON.stringify(data));
}
function loadHistory() {
  return JSON.parse(localStorage.getItem(LS_HISTORY) || "[]");
}
function saveHistory(data) {
  localStorage.setItem(LS_HISTORY, JSON.stringify(data));
}

/* ===== 商品登録 ===== */
function addProduct() {
  const code = codeEl.value.trim();
  if (!code) {
    alert("商品コードは必須です");
    return;
  }

  const products = loadProducts();
  if (products.some(p => p.code === code)) {
    alert("同じ商品コードが存在します");
    return;
  }

  products.push({
    code,
    name: nameEl.value.trim(),
    category: categoryEl.value.trim(),
    maker: makerEl.value.trim(),
    model: modelEl.value.trim(),
    stock: 0
  });

  saveProducts(products);
  clearInputs();
  renderAll();
}

/* ===== 在庫処理 ===== */
function stockIn() {
  stockChange("IN");
}
function stockOut() {
  stockChange("OUT");
}

function stockChange(type) {
  const code = productSelect.value;
  const qty = Number(qtyEl.value);
  if (!code || qty <= 0) return;

  const products = loadProducts();
  const p = products.find(p => p.code === code);
  if (!p) return;

  if (type === "OUT" && p.stock < qty) {
    alert("在庫不足");
    return;
  }

  p.stock += (type === "IN" ? qty : -qty);
  saveProducts(products);

  const history = loadHistory();
  history.unshift({
    time: new Date().toLocaleString(),
    code,
    type,
    qty
  });
  saveHistory(history);

  renderAll();
}

/* ===== 削除 ===== */
function deleteProduct(code) {
  if (!confirm("削除しますか？履歴は残ります")) return;
  const products = loadProducts().filter(p => p.code !== code);
  saveProducts(products);
  renderAll();
}

/* ===== 描画 ===== */
function renderAll() {
  renderProducts();
  renderSelect();
  renderHistory();
}

function renderProducts() {
  const list = productList;
  list.innerHTML = "";
  loadProducts().forEach(p => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <strong>${p.code}</strong> ${p.name || ""}<br>
      <span class="small">
        在庫: ${p.stock} /
        ${p.category || "-"} /
        ${p.maker || "-"} /
        ${p.model || "-"}
      </span>
      <button class="danger" onclick="deleteProduct('${p.code}')">削除</button>
    `;
    list.appendChild(div);
  });
}

function renderSelect() {
  const sel = productSelect;
  sel.innerHTML = "";
  loadProducts().forEach(p => {
    const o = document.createElement("option");
    o.value = p.code;
    o.textContent = `${p.code}｜${p.name || ""}`;
    sel.appendChild(o);
  });
}

function renderHistory() {
  const list = historyList;
  list.innerHTML = "";
  loadHistory().forEach(h => {
    const div = document.createElement("div");
    div.className = "list-item small";
    div.textContent =
      `${h.time} ${h.code} ${h.type} ${h.qty}`;
    list.appendChild(div);
  });
}

function clearInputs() {
  codeEl.value = "";
  nameEl.value = "";
  categoryEl.value = "";
  makerEl.value = "";
  modelEl.value = "";
}

/* ===== DOM ===== */
const codeEl = document.getElementById("code");
const nameEl = document.getElementById("name");
const categoryEl = document.getElementById("category");
const makerEl = document.getElementById("maker");
const modelEl = document.getElementById("model");
const productList = document.getElementById("productList");
const productSelect = document.getElementById("productSelect");
const qtyEl = document.getElementById("qty");
const historyList = document.getElementById("historyList");

renderAll();
</script>
</body>
</html>
