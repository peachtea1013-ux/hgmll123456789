<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
  content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>在庫管理ツール</title>

<style>
:root{
  --danger:#e53935;
  --warning:#fb8c00;
  --ok:#2e7d32;
  --bg:#f5f5f5;
  --card:#ffffff;
}
html,body{
  margin:0;
  padding:0;
  height:100dvh;
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
}
body{
  overflow:hidden;
  background:var(--bg);
}
.safe-area-top{
  height:10dvh;
  padding-top:env(safe-area-inset-top);
  background:#000;
}
.app{
  height:90dvh;
  display:flex;
  flex-direction:column;
}
header{
  height:48px;
  text-align:center;
  font-weight:bold;
  line-height:48px;
  background:#222;
  color:#fff;
}
main{
  flex:1;
  overflow-y:auto;
}
section{
  display:none;
  padding:8px;
}
section.active{
  display:block;
}
nav{
  height:56px;
  display:flex;
  background:#111;
}
nav button{
  flex:1;
  color:#fff;
  background:none;
  border:none;
  font-size:12px;
}
.product-row,
.history-row,
.master-row{
  background:var(--card);
  margin-bottom:6px;
  padding:6px;
  border-radius:6px;
}
.stock.danger{color:var(--danger);font-weight:bold;}
.stock.warning{color:var(--warning);font-weight:bold;}
.stock.ok{color:var(--ok);}

.modal-root{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  z-index:1000;
}
.modal-root.active{display:flex;}
.modal{
  background:#fff;
  margin:auto;
  width:90%;
  border-radius:8px;
  padding:8px;
}
.modal footer{
  display:flex;
  gap:8px;
}
.modal footer button{flex:1;}
</style>
</head>

<body>
<div class="safe-area-top"></div>

<div class="app">
<header id="header">在庫操作</header>

<main>
<section data-screen="stock" class="active"></section>
<section data-screen="history"></section>
<section data-screen="master"></section>
<section data-screen="calendar"></section>
<section data-screen="data"></section>
</main>

<nav>
<button data-nav="stock">在庫</button>
<button data-nav="history">履歴</button>
<button data-nav="master">マスタ</button>
<button data-nav="calendar">周期</button>
<button data-nav="data">連携</button>
</nav>
</div>

<div class="modal-root" id="modalRoot">
  <div class="modal">
    <header id="modalTitle"></header>
    <div id="modalBody"></div>
    <footer>
      <button id="modalCancel">キャンセル</button>
      <button id="modalOk">確定</button>
    </footer>
  </div>
</div>

<script>
/* =========================
   STATE 定義
========================= */
const STORAGE_KEY="inventory_app_state";

let state={
  meta:{version:"1.0",lastUpdated:null},
  masters:{},
  histories:[],
  orders:[],
  inventories:{active:false,sessionId:null,startedAt:null,snapshot:{}},
  ui:{
    currentScreen:"stock",
    selectedProductCode:null,
    modal:{type:null,visible:false,payload:null},
    filters:{category:null,keyword:""},
    calendar:{year:new Date().getFullYear(),month:new Date().getMonth()+1}
  }
};

/* =========================
   初期化
========================= */
function loadState(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{ state=JSON.parse(raw); }
    catch{ saveState(); }
  }else{
    saveState();
  }
  recalcAllStocks();
  render();
}
function saveState(){
  state.meta.lastUpdated=new Date().toISOString();
  localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
}

/* =========================
   在庫再計算
========================= */
function recalcAllStocks(){
  Object.values(state.masters).forEach(m=>m.stockCache=0);
  state.histories
    .filter(h=>!h.deleted)
    .sort((a,b)=>new Date(a.date)-new Date(b.date))
    .forEach(h=>{
      const m=state.masters[h.productCode];
      if(!m)return;
      if(h.type==="use")m.stockCache-=h.quantity;
      if(h.type==="receive")m.stockCache+=h.quantity;
      if(h.type==="inventory_adjust")m.stockCache=h.quantity;
    });
  saveState();
}

/* =========================
   画面制御
========================= */
function setScreen(name){
  state.ui.currentScreen=name;
  document.querySelectorAll("section").forEach(s=>{
    s.classList.toggle("active",s.dataset.screen===name);
  });
  document.getElementById("header").textContent={
    stock:"在庫操作",history:"操作履歴",
    master:"商品マスタ",calendar:"交換周期",data:"データ連携"
  }[name];
}

/* =========================
   モーダル
========================= */
function openModal(title,html,onOk){
  state.ui.modal.visible=true;
  document.getElementById("modalTitle").textContent=title;
  document.getElementById("modalBody").innerHTML=html;
  document.getElementById("modalRoot").classList.add("active");
  document.getElementById("modalOk").onclick=()=>{
    onOk();
    closeModal();
  };
}
function closeModal(){
  state.ui.modal.visible=false;
  document.getElementById("modalRoot").classList.remove("active");
}

/* =========================
   業務ロジック
========================= */
function addHistory(h){
  state.histories.push(h);
  recalcAllStocks();
}
function useProduct(code,qty){
  addHistory({id:Date.now(),productCode:code,type:"use",quantity:qty,date:new Date().toISOString(),deleted:false});
}
function receiveProduct(code,qty){
  addHistory({id:Date.now(),productCode:code,type:"receive",quantity:qty,date:new Date().toISOString(),deleted:false});
}

/* =========================
   Render
========================= */
function renderStock(){
  const el=document.querySelector('[data-screen="stock"]');
  el.innerHTML="";
  Object.values(state.masters).filter(m=>!m.deleted).forEach(m=>{
    const row=document.createElement("div");
    row.className="product-row";
    let cls="ok";
    if(m.stockCache<m.minStock)cls="danger";
    row.innerHTML=`
      <div>${m.name}</div>
      <div class="stock ${cls}">${m.stockCache}</div>
      <button>使用</button>
      <button>納入</button>
    `;
    row.querySelectorAll("button")[0].onclick=()=>{
      openModal("使用",'<input id="qty" type="number">',()=>{
        useProduct(m.productCode,Number(qty.value));
      });
    };
    row.querySelectorAll("button")[1].onclick=()=>{
      openModal("納入",'<input id="qty" type="number">',()=>{
        receiveProduct(m.productCode,Number(qty.value));
      });
    };
    el.appendChild(row);
  });
}
function render(){
  renderStock();
}

/* =========================
   ナビイベント
========================= */
document.querySelectorAll("nav button").forEach(b=>{
  b.onclick=()=>{ setScreen(b.dataset.nav); };
});
document.getElementById("modalCancel").onclick=closeModal;

/* 初期商品（サンプルなし → 空運用） */
loadState();
</script>
</body>
</html>
