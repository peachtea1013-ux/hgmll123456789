<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨åº«ãƒ»äºˆé˜²ä¿å…¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Pro</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); font-size: 14px; }
        
        /* Layout */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--primary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        
        nav { background: var(--surface); border-bottom: 1px solid var(--border); overflow-x: auto; white-space: nowrap; }
        .nav-tabs { display: flex; list-style: none; margin: 0; padding: 0; }
        .nav-item { padding: 1rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; font-weight: 500; color: var(--secondary); }
        .nav-item:hover { background: #f8fafc; }
        .nav-item.active { border-bottom-color: var(--primary); color: var(--primary); }

        main { flex: 1; overflow-y: auto; padding: 1rem; max-width: 1200px; margin: 0 auto; width: 100%; }

        /* Components */
        .card { background: var(--surface); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        
        input, select, textarea { padding: 0.6rem; border: 1px solid var(--border); border-radius: 4px; width: 100%; margin-bottom: 0.5rem; font-size: 1rem; }
        label { display: block; margin-bottom: 0.3rem; font-weight: 600; color: var(--secondary); font-size: 0.85rem; }

        /* Tables */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); }
        th { background: #f8fafc; color: var(--secondary); font-weight: 600; position: sticky; top: 0; }
        tr.stock-low { background-color: #fee2e2; } /* èµ¤èƒŒæ™¯ */
        tr.stock-warn { background-color: #fef3c7; } /* é»„èƒŒæ™¯ */

        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .stat-card { background: var(--surface); padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--border); }
        .stat-value { font-size: 1.8rem; font-weight: bold; display: block; }
        .stat-label { color: var(--secondary); font-size: 0.9rem; }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--surface); padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 1.5rem; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

        /* Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; gap: 0.5rem; align-items: center; }
        .flex-wrap { flex-wrap: wrap; }
        .justify-between { justify-content: space-between; }
        .mt-4 { margin-top: 1rem; }
        .badge { padding: 0.2rem 0.5rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        .badge-in { background: #dcfce7; color: #166534; }
        .badge-out { background: #fee2e2; color: #991b1b; }
        .badge-adj { background: #e0f2fe; color: #075985; }

        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: var(--border); margin-top: 1rem; }
        .calendar-day { background: var(--surface); min-height: 80px; padding: 0.5rem; font-size: 0.8rem; }
        .calendar-header { background: #f8fafc; padding: 0.5rem; text-align: center; font-weight: bold; }
        .cal-event { background: var(--primary); color: white; padding: 2px 4px; border-radius: 2px; margin-bottom: 2px; font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .nav-item { padding: 0.8rem 1rem; font-size: 0.9rem; }
            .btn { width: 100%; justify-content: center; margin-bottom: 0.5rem; }
            .flex-buttons .btn { width: auto; margin-bottom: 0; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>åœ¨åº«ãƒ»ä¿å…¨ç®¡ç† Pro</h1>
        <div id="clock">Loading...</div>
    </header>

    <nav>
        <ul class="nav-tabs">
            <li class="nav-item active" onclick="app.router('dashboard')">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</li>
            <li class="nav-item" onclick="app.router('inventory')">åœ¨åº«ä¸€è¦§</li>
            <li class="nav-item" onclick="app.router('calendar')">ä¿å…¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</li>
            <li class="nav-item" onclick="app.router('history')">å±¥æ­´</li>
            <li class="nav-item" onclick="app.router('master')">ãƒã‚¹ã‚¿ç®¡ç†</li>
            <li class="nav-item" onclick="app.router('settings')">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</li>
        </ul>
    </nav>

    <main id="main-content">
        </main>
</div>

<div id="modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Title</h2>
            <button class="btn-outline btn-sm" onclick="app.closeModal()">âœ•</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<script>
/**
 * Application Logic
 * Architecture: Singleton 'app' object containing State, Logic, and UI renderers.
 */
const app = {
    // --- Data Model ---
    state: {
        products: [], // { id, code, name, category, maker, min_stock, stock, unit_price, lead_time, cycle_days, is_deleted, last_check_date, note }
        history: [],  // { id, date, product_id, type(IN/OUT/ADJ), amount, balance, reason }
        categories: ['æ¶ˆè€—å“', 'éƒ¨å“', 'å·¥å…·', 'ãã®ä»–'],
        makers: [],
        last_updated: null
    },

    // --- Core System Methods ---
    init() {
        this.loadState();
        this.updateClock();
        setInterval(() => this.updateClock(), 1000 * 60); // 1åˆ†æ›´æ–°
        this.router('dashboard');
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æ£šå¸ä¸­ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è­¦å‘Š
        if (localStorage.getItem('stocktaking_wip')) {
            alert('ä¸­æ–­ã•ã‚ŒãŸæ£šå¸ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚ã€Œåœ¨åº«ä¸€è¦§ã€ã®æ£šå¸ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰å†é–‹ã—ã¦ãã ã•ã„ã€‚');
        }
    },

    loadState() {
        const stored = localStorage.getItem('inventory_app_v1');
        if (stored) {
            this.state = JSON.parse(stored);
        } else {
            this.seedData(); // åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
        }
    },

    saveState() {
        this.state.last_updated = new Date().toISOString();
        localStorage.setItem('inventory_app_v1', JSON.stringify(this.state));
    },

    seedData() {
        // ãƒ‡ãƒ¢ç”¨åˆæœŸãƒ‡ãƒ¼ã‚¿
        this.state.products = [
            { id: 1, code: 'A-001', name: 'M10 ãƒœãƒ«ãƒˆ', category: 'éƒ¨å“', maker: 'ãƒã‚¸å·¥æ¥­', min_stock: 50, stock: 40, unit_price: 20, cycle_days: 0, is_deleted: false, note: '' },
            { id: 2, code: 'F-100', name: 'ã‚ªã‚¤ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼', category: 'æ¶ˆè€—å“', maker: 'ãƒ‘ãƒ¼ãƒ„Co', min_stock: 5, stock: 10, unit_price: 1500, cycle_days: 30, is_deleted: false, note: 'æ¯æœˆäº¤æ›' },
            { id: 3, code: 'T-555', name: 'é›»å‹•ãƒ‰ãƒªãƒ«', category: 'å·¥å…·', maker: 'ãƒã‚­ã‚¿', min_stock: 1, stock: 3, unit_price: 15000, cycle_days: 365, is_deleted: false, note: 'å¹´æ¬¡ç‚¹æ¤œ' },
        ];
        this.state.history = [
            { id: 1, date: new Date().toISOString(), product_id: 1, type: 'IN', amount: 50, balance: 50, reason: 'åˆæœŸåœ¨åº«' },
            { id: 2, date: new Date().toISOString(), product_id: 1, type: 'OUT', amount: 10, balance: 40, reason: 'ä½¿ç”¨' }
        ];
        this.saveState();
    },

    updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleString('ja-JP', { 
            month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
        });
    },

    // --- Router / View Rendering ---
    router(viewName) {
        // Update Tabs
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`.nav-item[onclick*="'${viewName}'"]`).classList.add('active');

        const main = document.getElementById('main-content');
        main.innerHTML = ''; // Clear content

        switch(viewName) {
            case 'dashboard': this.renderDashboard(main); break;
            case 'inventory': this.renderInventory(main); break;
            case 'calendar': this.renderCalendar(main); break;
            case 'history': this.renderHistory(main); break;
            case 'master': this.renderMaster(main); break;
            case 'settings': this.renderSettings(main); break;
        }
    },

    // --- 1. Dashboard ---
    renderDashboard(container) {
        const products = this.state.products.filter(p => !p.is_deleted);
        const lowStock = products.filter(p => p.stock < p.min_stock).length;
        const totalValue = products.reduce((sum, p) => sum + (p.stock * p.unit_price), 0);
        
        // äº¤æ›æ¨å¥¨æ—¥ã®è¨ˆç®—ï¼ˆç°¡æ˜“ï¼‰
        const alerts = this.getMaintenanceAlerts().length;

        container.innerHTML = `
            <h2>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-label">ç·å“ç›®æ•°</span>
                    <span class="stat-value">${products.length}</span>
                </div>
                <div class="stat-card" style="${lowStock > 0 ? 'border-color:var(--danger); background:#fee2e2;' : ''}">
                    <span class="stat-label">ç™ºæ³¨ç‚¹å‰²ã‚Œ</span>
                    <span class="stat-value ${lowStock > 0 ? 'text-danger' : ''}">${lowStock}</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">åœ¨åº«è³‡ç”£ç·é¡</span>
                    <span class="stat-value">Â¥${totalValue.toLocaleString()}</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">äº¤æ›æ™‚æœŸã‚¢ãƒ©ãƒ¼ãƒˆ</span>
                    <span class="stat-value ${alerts > 0 ? 'text-warning' : ''}">${alerts} ä»¶</span>
                </div>
            </div>

            <div class="card">
                <h3>è¦å¯¾å¿œã‚¢ã‚¤ãƒ†ãƒ  (ç™ºæ³¨ç‚¹å‰²ã‚Œ)</h3>
                ${lowStock === 0 ? '<p>ç¾åœ¨ã€ä¸è¶³ã—ã¦ã„ã‚‹åœ¨åº«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>' : this.buildSimpleTable(products.filter(p => p.stock < p.min_stock))}
            </div>
        `;
    },

    buildSimpleTable(list) {
        return `
            <table>
                <thead><tr><th>ã‚³ãƒ¼ãƒ‰</th><th>å“å</th><th>ç¾åœ¨åº«</th><th>åŸºæº–æ•°</th></tr></thead>
                <tbody>
                    ${list.map(p => `
                        <tr>
                            <td>${p.code}</td>
                            <td>${p.name}</td>
                            <td class="text-danger"><b>${p.stock}</b></td>
                            <td>${p.min_stock}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    // --- 2. Inventory Management ---
    renderInventory(container) {
        // æ£šå¸ãƒ¢ãƒ¼ãƒ‰ä¸­ã‹ãƒã‚§ãƒƒã‚¯
        const isStocktaking = localStorage.getItem('stocktaking_wip') !== null;
        let wipData = isStocktaking ? JSON.parse(localStorage.getItem('stocktaking_wip')) : {};

        const products = this.state.products.filter(p => !p.is_deleted);
        
        let html = `
            <div class="flex justify-between flex-wrap" style="margin-bottom:1rem;">
                <h2>åœ¨åº«ä¸€è¦§</h2>
                <div class="flex-buttons">
                    ${!isStocktaking ? 
                        `<button class="btn btn-primary" onclick="app.startStocktaking()">ğŸ“‹ æ£šå¸é–‹å§‹</button>` : 
                        `<button class="btn btn-danger" onclick="app.finishStocktaking()">âœ… æ£šå¸ç¢ºå®š</button>
                         <button class="btn btn-outline" onclick="app.cancelStocktaking()">ä¸­æ–­ãƒ»ç ´æ£„</button>`
                    }
                </div>
            </div>
            
            <div class="card">
                <input type="text" id="search-box" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ (ã‚³ãƒ¼ãƒ‰ã€å“å)..." onkeyup="app.filterInventory()">
                <div class="table-responsive">
                    <table id="inv-table">
                        <thead>
                            <tr>
                                <th>ã‚³ãƒ¼ãƒ‰</th>
                                <th>å“å</th>
                                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                                <th>ç¾åœ¨åº«</th>
                                ${isStocktaking ? '<th>å®Ÿåœ¨åº«å…¥åŠ›</th>' : '<th>æ“ä½œ</th>'}
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(p => {
                                const isLow = p.stock < p.min_stock;
                                const isWarn = p.stock < p.min_stock * 1.2;
                                const rowClass = isLow ? 'stock-low' : (isWarn ? 'stock-warn' : '');
                                
                                let actionCell = '';
                                if (isStocktaking) {
                                    // æ£šå¸ãƒ¢ãƒ¼ãƒ‰ï¼šå…¥åŠ›æ¬„
                                    const val = wipData[p.id] !== undefined ? wipData[p.id] : '';
                                    actionCell = `<input type="number" value="${val}" style="width:100px; margin:0;" onchange="app.saveWip(${p.id}, this.value)">`;
                                } else {
                                    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šå…¥å‡ºåº«ãƒœã‚¿ãƒ³
                                    actionCell = `
                                        <button class="btn btn-sm btn-primary" onclick="app.openStockModal(${p.id}, 'IN')">å…¥åº«</button>
                                        <button class="btn btn-sm btn-outline" onclick="app.openStockModal(${p.id}, 'OUT')">å‡ºåº«</button>
                                    `;
                                }

                                return `
                                    <tr class="${rowClass}" data-search="${p.code} ${p.name} ${p.category}">
                                        <td>${p.code}</td>
                                        <td>${p.name}</td>
                                        <td>${p.category}</td>
                                        <td><b>${p.stock}</b> <span style="font-size:0.8em; color:gray;">(åŸºæº–:${p.min_stock})</span></td>
                                        <td>${actionCell}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        container.innerHTML = html;
    },

    filterInventory() {
        const term = document.getElementById('search-box').value.toLowerCase();
        document.querySelectorAll('#inv-table tbody tr').forEach(row => {
            const text = row.getAttribute('data-search').toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
        });
    },

    // Stock Operations (In/Out)
    openStockModal(id, type) {
        const p = this.state.products.find(x => x.id === id);
        if(!p) return;
        
        const title = type === 'IN' ? 'å…¥åº«å‡¦ç†' : 'å‡ºåº«å‡¦ç†';
        const html = `
            <div class="card" style="background:#f8fafc; border:none; box-shadow:none;">
                <p><strong>${p.name}</strong> (ç¾åœ¨: ${p.stock})</p>
                <label>æ•°é‡</label>
                <input type="number" id="stock-amount" min="1" value="1">
                <label>ç†ç”±ãƒ»å‚™è€ƒ</label>
                <input type="text" id="stock-reason" placeholder="ä¾‹: å®šæœŸè£œå……ã€ç ´æäº¤æ›ãªã©">
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="app.submitStock(${id}, '${type}')">å®Ÿè¡Œ</button>
                </div>
            </div>
        `;
        this.showModal(title, html);
    },

    submitStock(id, type) {
        const amount = parseInt(document.getElementById('stock-amount').value);
        const reason = document.getElementById('stock-reason').value;
        if (!amount || amount <= 0) return alert('æ•°é‡ã¯1ä»¥ä¸Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

        const p = this.state.products.find(x => x.id === id);
        const oldStock = p.stock;
        
        if (type === 'OUT' && p.stock < amount) {
            if (!confirm(`åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆç¾åœ¨: ${p.stock}ï¼‰ã€‚\nãƒã‚¤ãƒŠã‚¹åœ¨åº«ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        }

        // Update Stock
        p.stock = type === 'IN' ? p.stock + amount : p.stock - amount;
        
        // Add History
        this.state.history.unshift({
            id: Date.now(),
            date: new Date().toISOString(),
            product_id: p.id,
            type: type,
            amount: amount,
            balance: p.stock,
            reason: reason || (type === 'IN' ? 'å…¥åº«' : 'å‡ºåº«')
        });

        this.saveState();
        this.closeModal();
        this.router('inventory');
    },

    // Stocktaking Logic (æ£šå¸)
    startStocktaking() {
        if(confirm('æ£šå¸ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\nå…¥åŠ›é€”ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚')) {
            localStorage.setItem('stocktaking_wip', JSON.stringify({}));
            this.router('inventory');
        }
    },
    
    saveWip(id, val) {
        let wip = JSON.parse(localStorage.getItem('stocktaking_wip'));
        wip[id] = parseInt(val);
        localStorage.setItem('stocktaking_wip', JSON.stringify(wip));
    },

    cancelStocktaking() {
        if(confirm('å…¥åŠ›ä¸­ã®æ£šå¸ãƒ‡ãƒ¼ã‚¿ã‚’ç ´æ£„ã—ã¦é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
            localStorage.removeItem('stocktaking_wip');
            this.router('inventory');
        }
    },

    finishStocktaking() {
        if(!confirm('æ£šå¸ã‚’ç¢ºå®šã—ã¾ã™ã€‚\nå…¥åŠ›ã•ã‚ŒãŸæ•°å€¤ã§ã‚·ã‚¹ãƒ†ãƒ åœ¨åº«ã‚’ä¸Šæ›¸ãã—ã€å·®åˆ†ã‚’å±¥æ­´ã«è¨˜éŒ²ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

        const wip = JSON.parse(localStorage.getItem('stocktaking_wip'));
        const products = this.state.products.filter(p => !p.is_deleted);
        let updateCount = 0;

        products.forEach(p => {
            if (wip[p.id] !== undefined && !isNaN(wip[p.id])) {
                const actual = wip[p.id];
                const diff = actual - p.stock;
                
                if (diff !== 0) {
                    p.stock = actual;
                    p.last_check_date = new Date().toISOString();
                    
                    this.state.history.unshift({
                        id: Date.now() + Math.random(), // Unique ID
                        date: new Date().toISOString(),
                        product_id: p.id,
                        type: 'ADJ', // Adjust
                        amount: Math.abs(diff),
                        balance: p.stock,
                        reason: `æ£šå¸å·®ç•°èª¿æ•´ (${diff > 0 ? '+' : ''}${diff})`
                    });
                    updateCount++;
                }
            }
        });

        this.saveState();
        localStorage.removeItem('stocktaking_wip');
        alert(`${updateCount}ä»¶ã®åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`);
        this.router('inventory');
    },

    // --- 3. Maintenance Calendar ---
    renderCalendar(container) {
        const events = this.getMaintenanceAlerts();
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        
        // Month generation logic
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay(); // 0=Sun

        let gridHtml = '';
        // Empty slots for start
        for(let i=0; i<startDayOfWeek; i++) gridHtml += `<div class="calendar-day" style="background:#f1f5f9;"></div>`;
        
        // Days
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayEvents = events.filter(e => e.date === dateStr);
            
            gridHtml += `
                <div class="calendar-day">
                    <strong>${d}</strong>
                    ${dayEvents.map(e => `<div class="cal-event" onclick="alert('${e.name}: äº¤æ›äºˆå®š')">${e.name}</div>`).join('')}
                </div>
            `;
        }

        container.innerHTML = `
            <div class="flex justify-between">
                <h2>ä¿å…¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (${year}å¹´${month+1}æœˆ)</h2>
                <button class="btn btn-outline" onclick="alert('ç°¡æ˜“ç‰ˆã®ãŸã‚æœˆåˆ‡ã‚Šæ›¿ãˆã¯æœªå®Ÿè£…ã§ã™')">ä»Šæœˆ</button>
            </div>
            <div class="calendar-header-row" style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; margin-top:1rem;">
                <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
            </div>
            <div class="calendar-grid">
                ${gridHtml}
            </div>
            <div class="card mt-4">
                <h3>ç›´è¿‘ã®äº¤æ›äºˆå®šãƒªã‚¹ãƒˆ</h3>
                <ul>
                    ${events.slice(0, 5).map(e => `<li>${e.date}: <strong>${e.name}</strong> (å‘¨æœŸ: ${e.cycle}æ—¥)</li>`).join('')}
                </ul>
            </div>
        `;
    },

    getMaintenanceAlerts() {
        // Logic: Find products with cycle_days > 0.
        // Find last 'OUT' or 'REPLACE' history.
        // Calc next date. If weekend, push to Monday.
        const alerts = [];
        this.state.products.filter(p => !p.is_deleted && p.cycle_days > 0).forEach(p => {
            // Find last OUT
            const lastOut = this.state.history.find(h => h.product_id === p.id && h.type === 'OUT');
            let baseDate = lastOut ? new Date(lastOut.date) : new Date(); // If never used, assume today for demo logic
            
            let nextDate = new Date(baseDate);
            nextDate.setDate(nextDate.getDate() + p.cycle_days);

            // Weekend adjustment
            const day = nextDate.getDay();
            if (day === 6) nextDate.setDate(nextDate.getDate() + 2); // Sat -> Mon
            if (day === 0) nextDate.setDate(nextDate.getDate() + 1); // Sun -> Mon

            alerts.push({
                date: nextDate.toISOString().split('T')[0],
                name: p.name,
                cycle: p.cycle_days
            });
        });
        return alerts.sort((a,b) => a.date.localeCompare(b.date));
    },

    // --- 4. History ---
    renderHistory(container) {
        container.innerHTML = `
            <h2>å…¥å‡ºåº«ãƒ»æ£šå¸å±¥æ­´</h2>
            <div class="card table-responsive">
                <table>
                    <thead>
                        <tr><th>æ—¥æ™‚</th><th>ç¨®åˆ¥</th><th>å“å</th><th>æ•°é‡</th><th>åœ¨åº«æ®‹</th><th>ç†ç”±</th></tr>
                    </thead>
                    <tbody>
                        ${this.state.history.slice(0, 50).map(h => { // Show last 50
                            const p = this.state.products.find(x => x.id === h.product_id) || {name: 'å‰Šé™¤æ¸ˆ'};
                            const badgeClass = h.type === 'IN' ? 'badge-in' : (h.type === 'OUT' ? 'badge-out' : 'badge-adj');
                            const typeLabel = h.type === 'IN' ? 'å…¥åº«' : (h.type === 'OUT' ? 'å‡ºåº«' : 'æ£šå¸');
                            return `
                                <tr>
                                    <td>${new Date(h.date).toLocaleString()}</td>
                                    <td><span class="badge ${badgeClass}">${typeLabel}</span></td>
                                    <td>${p.name}</td>
                                    <td>${h.amount}</td>
                                    <td>${h.balance}</td>
                                    <td>${h.reason}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },

    // --- 5. Master Management ---
    renderMaster(container) {
        const products = this.state.products.filter(p => !p.is_deleted);
        container.innerHTML = `
            <div class="flex justify-between flex-wrap">
                <h2>å•†å“ãƒã‚¹ã‚¿ç®¡ç†</h2>
                <div class="flex-buttons">
                    <button class="btn btn-primary" onclick="app.editProduct(null)">ï¼‹ æ–°è¦ç™»éŒ²</button>
                    <button class="btn btn-outline" onclick="app.exportCSV()">â¬‡ CSVå‡ºåŠ›</button>
                    <label class="btn btn-outline" style="margin-bottom:0;">
                        â¬† CSVèª­è¾¼ <input type="file" accept=".csv" class="hidden" onchange="app.importCSV(this)">
                    </label>
                </div>
            </div>
            <div class="card table-responsive mt-4">
                <table>
                    <thead><tr><th>ID</th><th>ã‚³ãƒ¼ãƒ‰</th><th>å“å</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>åŸºæº–åœ¨åº«</th><th>å‘¨æœŸ(æ—¥)</th><th>ç·¨é›†</th></tr></thead>
                    <tbody>
                        ${products.map(p => `
                            <tr>
                                <td>${p.id}</td>
                                <td>${p.code}</td>
                                <td>${p.name}</td>
                                <td>${p.category}</td>
                                <td>${p.min_stock}</td>
                                <td>${p.cycle_days}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline" onclick="app.editProduct(${p.id})">ç·¨é›†</button>
                                    <button class="btn btn-sm btn-danger" onclick="app.deleteProduct(${p.id})">å‰Šé™¤</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },

    editProduct(id) {
        const isNew = id === null;
        const p = isNew ? { code:'', name:'', category:'æ¶ˆè€—å“', min_stock:0, cycle_days:0, note:'' } : this.state.products.find(x => x.id === id);

        const html = `
            <form onsubmit="event.preventDefault(); app.saveProduct(${id});">
                <label>å•†å“ã‚³ãƒ¼ãƒ‰</label>
                <input type="text" id="edit-code" value="${p.code}" required>
                <label>å“å</label>
                <input type="text" id="edit-name" value="${p.name}" required>
                <label>ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="edit-category">
                    ${this.state.categories.map(c => `<option ${c === p.category ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
                <div class="flex">
                    <div style="flex:1">
                        <label>æœ€ä½åœ¨åº«æ•°ï¼ˆç™ºæ³¨ç‚¹ï¼‰</label>
                        <input type="number" id="edit-min" value="${p.min_stock}">
                    </div>
                    <div style="flex:1">
                        <label>äº¤æ›å‘¨æœŸ(æ—¥) 0=ãªã—</label>
                        <input type="number" id="edit-cycle" value="${p.cycle_days}">
                    </div>
                </div>
                <label>å‚™è€ƒ</label>
                <textarea id="edit-note">${p.note || ''}</textarea>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        `;
        this.showModal(isNew ? 'å•†å“ç™»éŒ²' : 'å•†å“ç·¨é›†', html);
    },

    saveProduct(id) {
        const code = document.getElementById('edit-code').value;
        const name = document.getElementById('edit-name').value;
        const category = document.getElementById('edit-category').value;
        const min_stock = parseInt(document.getElementById('edit-min').value) || 0;
        const cycle_days = parseInt(document.getElementById('edit-cycle').value) || 0;
        const note = document.getElementById('edit-note').value;

        if(id === null) {
            // New
            const newId = this.state.products.length > 0 ? Math.max(...this.state.products.map(p => p.id)) + 1 : 1;
            this.state.products.push({
                id: newId, code, name, category, min_stock, cycle_days, note, 
                stock: 0, unit_price: 0, maker: '', is_deleted: false, last_check_date: null
            });
        } else {
            // Update
            const p = this.state.products.find(x => x.id === id);
            p.code = code; p.name = name; p.category = category; p.min_stock = min_stock; p.cycle_days = cycle_days; p.note = note;
        }
        this.saveState();
        this.closeModal();
        this.router('master');
    },

    deleteProduct(id) {
        if(confirm('æœ¬å½“ã«ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆè«–ç†å‰Šé™¤ï¼‰')) {
            const p = this.state.products.find(x => x.id === id);
            p.is_deleted = true;
            this.saveState();
            this.renderMaster(document.getElementById('main-content'));
        }
    },

    // CSV Import/Export
    exportCSV() {
        const products = this.state.products.filter(p => !p.is_deleted);
        const header = "ID,Code,Name,Category,Stock,MinStock,CycleDays\n";
        const rows = products.map(p => `${p.id},"${p.code}","${p.name}","${p.category}",${p.stock},${p.min_stock},${p.cycle_days}`).join("\n");
        
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), header + rows], { type: "text/csv" }); // Add BOM
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    },

    importCSV(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result;
            const lines = text.split(/\r\n|\n/);
            let success = 0;
            // Skip header, Simple parse
            for(let i=1; i<lines.length; i++) {
                if(!lines[i]) continue;
                // Note: This is a very basic CSV parser. Doesn't handle commas inside quotes robustly.
                const cols = lines[i].split(',').map(s => s.replace(/"/g, '')); 
                if(cols.length < 3) continue;

                // Upsert logic based on Code
                const code = cols[1];
                const existing = this.state.products.find(p => p.code === code);
                if(existing) {
                    existing.name = cols[2];
                    existing.stock = parseInt(cols[4]) || existing.stock;
                    existing.is_deleted = false;
                } else {
                    const newId = Math.max(...this.state.products.map(p => p.id), 0) + 1;
                    this.state.products.push({
                        id: newId, code: code, name: cols[2], category: cols[3]||'æœªåˆ†é¡',
                        stock: parseInt(cols[4])||0, min_stock: parseInt(cols[5])||0, cycle_days: parseInt(cols[6])||0,
                        is_deleted: false, maker: '', unit_price: 0
                    });
                }
                success++;
            }
            this.saveState();
            alert(`${success}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
            this.router('master');
            input.value = ''; // Reset
        };
        reader.readAsText(file);
    },

    // --- 6. System Settings ---
    renderSettings(container) {
        container.innerHTML = `
            <h2>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
            <div class="card">
                <h3>ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— (JSON)</h3>
                <p>ç¾åœ¨ã®å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆåœ¨åº«ã€å±¥æ­´ã€è¨­å®šï¼‰ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
                <button class="btn btn-primary" onclick="app.backupJSON()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            <div class="card">
                <h3>ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</h3>
                <p class="text-danger">æ³¨æ„: æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚</p>
                <input type="file" id="restore-file" accept=".json">
                <button class="btn btn-danger mt-4" onclick="app.restoreJSON()">ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ</button>
            </div>
            <div class="card">
                <h3>ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</h3>
                <button class="btn btn-danger" onclick="app.resetAll()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹</button>
            </div>
        `;
    },

    backupJSON() {
        const blob = new Blob([JSON.stringify(this.state, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `inventory_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    },

    restoreJSON() {
        const file = document.getElementById('restore-file').files[0];
        if(!file) return alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        if(!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒã™ã¹ã¦å¤±ã‚ã‚Œã¾ã™ã€‚å¾©å…ƒã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if(data.products && data.history) {
                    this.state = data;
                    this.saveState();
                    alert('å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                    location.reload();
                } else {
                    alert('ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚');
                }
            } catch(err) {
                alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err);
            }
        };
        reader.readAsText(file);
    },

    resetAll() {
        if(confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
            localStorage.removeItem('inventory_app_v1');
            localStorage.removeItem('stocktaking_wip');
            location.reload();
        }
    },

    // --- Modal Utilities ---
    showModal(title, htmlBody) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-body').innerHTML = htmlBody;
        document.getElementById('modal').classList.add('open');
    },
    
    closeModal() {
        document.getElementById('modal').classList.remove('open');
    }
};

// Initialize App
document.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>
</html>
